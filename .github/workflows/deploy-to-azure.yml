# .github/workflows/deploy-to-azure.yml

name: Deploy EliteDynamicsPro Function App to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: EliteDynamicsFuncions
  PYTHON_VERSION: '3.11'
  FUNCTION_APP_PATH: '.' # Asume que tu código está en la raíz del repo
  PYTHON_PACKAGE_PATH: '.python_packages' # Carpeta donde se instalarán las dependencias

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # environment: production # Puedes quitarlo si no usas secretos de repositorio específicos del entorno

    steps:
    - name: Checkout repository content
      uses: actions/checkout@v4

    - name: Setup Python version
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        # cache: 'pip' # Opcional, puedes quitarlo si el warning de caché te molesta

    # --- PASO PARA INSTALAR DEPENDENCIAS EN .python_packages ---
    - name: Install Python dependencies
      run: |
        python -m venv ${{ env.PYTHON_PACKAGE_PATH }}
        source ${{ env.PYTHON_PACKAGE_PATH }}/bin/activate
        python -m pip install --upgrade pip
        pip install -r ${{ env.FUNCTION_APP_PATH }}/requirements.txt --target="${{ env.PYTHON_PACKAGE_PATH }}/lib/python${{ env.PYTHON_VERSION }}/site-packages"
    # ----------------------------------------------------------

    - name: Login via Azure Credentials
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Functions
      uses: azure/functions-action@v1
      id: deploy-to-function-app
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ${{ env.FUNCTION_APP_PATH }} # La acción empaquetará desde aquí, incluyendo la carpeta .python_packages
        # --- PARÁMETROS PARA DESACTIVAR BUILD REMOTO EN AZURE ---
        # Esto le dice a Azure que NO intente construir dependencias,
        # porque ya las incluimos en el paquete ZIP en la carpeta .python_packages
        scm-do-build-during-deployment: false
        enable-oryx-build: false
        # -------------------------------------------------------------
        # NO necesitamos 'app-settings' aquí si ya están bien en el Portal de Azure.

    - name: Azure logout
      run: |
        az logout
      if: always()